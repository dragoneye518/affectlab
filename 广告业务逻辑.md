# 广告业务逻辑（微信小程序版）

## 1. 目标与口径

本项目里「糖果 / CANDY / 算力」本质上是同一套余额积分系统（后端字段为 `balance`）。为了让统计口径正确、账本可对账，**广告相关收益原则上都应该以“充值（RECHARGE）”入账**，再由实际使用行为产生“消费（CONSUME）”扣减。

## 2. 当前看广告的路径梳理

### 2.1 首页顶部按钮（看广告 +10）

- 入口位置：
  - 首页顶部导航组件触发 `watchAd` 事件，页面接管展示广告遮罩。
  - 相关文件：  
    - [navbar.js](file:///Users/zhumingjun/ai/affectlab/components/navbar/navbar.js)  
    - [index.js](file:///Users/zhumingjun/ai/affectlab/pages/index/index.js)
- 行为：
  - 展示广告遮罩（模拟 5 秒）。
  - 完成后请求后端入账：`POST /affectlab/api/user/reward/ad`
- 入账：
  - 后端固定入账 `+10`（可用环境变量覆写）：`AFFECTLAB_AD_REWARD_AMOUNT`
  - 流水写入：`type=RECHARGE, reason=AD`

### 2.2 我的页按钮（看广告 +10）

- 入口位置：
  - 我的页按钮点击后并不直接入账，而是跳转回首页并设置“进入即打开广告”的标志。
  - 相关文件：  
    - [profile.js](file:///Users/zhumingjun/ai/affectlab/pages/profile/profile.js)  
    - [index.js](file:///Users/zhumingjun/ai/affectlab/pages/index/index.js)
- 行为：
  - `profile.js` 写入：
    - `cp_open_ad_on_load=true`（首页 `onShow` 自动弹广告）
    - `cp_after_ad_redirect=/pages/profile/profile`（广告结束后自动跳回）
  - 首页完成广告后走与 2.1 同一入账链路。
- 入账：
  - 与 2.1 相同：`+10`，流水 `RECHARGE/AD`。

### 2.3 算力不足时的补给广告（看广告补充后再生成）

- 入口位置：
  - 用户输入确认时（或生成过程中后端返回余额不足）触发：弹出广告遮罩。
  - 相关文件：  
    - [index.js](file:///Users/zhumingjun/ai/affectlab/pages/index/index.js)
- 行为：
  - 弹广告 -> 广告完成 -> 调用 `POST /user/reward/ad` 充值 -> 用户再次发起生成。
- 入账：
  - 与 2.1 相同：`+10`，流水 `RECHARGE/AD`。
- 备注：
  - 这条链路的本质是“余额不足时的兜底充值入口”，属于付费补给路径。

### 2.4 结果页重抽广告（看广告 · 逆天改命）

- 入口位置：
  - 结果页（非 SSR 时）展示“看广告 · 逆天改命”按钮。
  - 相关文件：  
    - [result-view.wxml](file:///Users/zhumingjun/ai/affectlab/components/result-view/result-view.wxml)  
    - [index.js](file:///Users/zhumingjun/ai/affectlab/pages/index/index.js)  
    - [affectlab_server.py](file:///Users/zhumingjun/ai/affectlab/server_py/affectlab_server.py)
- 行为（已改进为“先充值、再消费”的记账方式）：
  1. 展示广告遮罩（模拟 5 秒）。
  2. 广告完成后调用：`POST /affectlab/api/user/reward/ad`，携带 `scene=REROLL` 和 `templateId`。
  3. 后端按模板价格入账“重抽补贴”，并写一条充值流水。
  4. 立刻发起下一次生成请求：`POST /affectlab/api/cards/generate`，携带 `reroll=true`，并按模板价格正常扣费。
  5. 生成时启用“重抽稀有度兜底”（N/R 会被提升到 SR/SSR）。
- 入账与扣费：
  - 充值：`RECHARGE/AD_REROLL`，金额 = 当前模板 `cost`（默认 1）。
  - 消费：`CONSUME/REROLL_GENERATE`，金额 = `-cost`。
  - 好处：重抽既能保证玩法体验，又能在账本与统计里严格对账（充值与消费闭环）。

#### 2.4.1 关键澄清：重抽不是“广告 +10，再生成 -1”

- “广告补给 +10”只发生在 `scene=CANDY` 的广告入口（2.1/2.2/2.3）。
- “重抽广告”走的是 `scene=REROLL`：**先按当前模板 `cost` 充值 +cost，再立刻生成扣 -cost，净余额变化=0**。
  - 如果模板 `cost=1`，你看到的就是“+1 然后 -1”；
  - 如果模板 `cost=3`，你看到的就是“+3 然后 -3”。
- 这条链路的价值不在“加算力”，而在“提升稀有度兜底”：重抽生成会把 N/R 提升到 SR/SSR，提高爽感但不改变经济总量。

## 3. 后端记账规则（单一事实来源）

### 3.1 每日补给（非广告）

- 接口：`POST /affectlab/api/user/reward/daily`
- 规则：
  - 每日最多一次（基于 `last_daily_date`）。
  - 入账金额默认 `+10`（可用环境变量覆写）：`AFFECTLAB_DAILY_REWARD_AMOUNT`
  - 流水：`type=RECHARGE, reason=DAILY`

### 3.2 广告补给（广告 +10）

- 接口：`POST /affectlab/api/user/reward/ad`（`scene=CANDY` 或缺省）
- 规则：
  - 入账金额固定为 `AFFECTLAB_AD_REWARD_AMOUNT`（默认 10）。
  - 不再信任前端传入的 `amount`（防止人为改参薅算力）。
  - 流水：`type=RECHARGE, reason=AD`

### 3.3 广告重抽补贴（广告后重抽）

- 接口：`POST /affectlab/api/user/reward/ad`（`scene=REROLL`，带 `templateId`）
- 规则：
  - 入账金额 = 模板 `cost`（默认 1）。
  - 流水：`type=RECHARGE, reason=AD_REROLL, project_id=templateId`

### 3.4 生成扣费与重抽扣费

- 接口：`POST /affectlab/api/cards/generate`
- 规则：
  - 普通生成：`CONSUME/GENERATE`，扣减模板 `cost`。
  - 重抽生成（`reroll=true`）：`CONSUME/REROLL_GENERATE`，扣减模板 `cost`，并启用更强的稀有度兜底。

## 4. 是否需要统一改进设计（辩证分析）

### 4.1 统一为“加算力充值”的收益模型（推荐）

- 优点：
  - **账本口径统一**：所有广告带来的收益都体现在 `RECHARGE`，统计上更直观。
  - **可对账**：重抽玩法也能形成“充值→消费”的闭环，不需要额外引入特殊流水类型解释。
  - **扩展性强**：以后接入不同广告位、不同奖励系数，只需增加 `scene`/策略即可。
- 缺点：
  - **可转移性**：广告重抽补贴如果“直接给算力”，用户可能拿去做别的用途，弱化“必须用于重抽”的约束。
  - **反作弊要求更高**：如果未来接真实广告 SDK，需要与服务端验签联动，否则仍可能被刷。

### 4.2 保持“重抽不加算力，只给一次免费券”（不推荐作为长期方案）

- 优点：
  - 奖励强约束，不会被挪用。
- 缺点：
  - 账本口径割裂（充值统计不完整），用户理解成本高，数据分析也更难。

结论：当前阶段（先把玩法与口径打通）更适合选 4.1；等接入真实广告与风控后，再进一步把 `scene=REROLL` 升级为“服务端一次性券 + 验签”会更稳。

## 5. 当前算力价格与奖励是否合理（建议）

### 5.1 当前现状

- 模板 `cost` 主要分布在 `1~3`（来源：`utils/constants.js` 同步入库）。
- 每日补给 +10；广告补给 +10；新用户初始余额约 20（以实际后端为准）。

这意味着：
- 一次广告补给可覆盖大约 `3~10` 次生成（取决于模板 cost）。
- 用户会很快进入“算力宽松”状态，广告的边际价值下降。

### 5.2 两条可选的定价方向

**方向 A：保持奖励 +10，不动奖励，整体把模板 cost 按 10 倍放大（推荐更稳）**
- 例：现有 cost=1/2/3 -> 调整为 10/20/30。
- 好处：
  - UI 不需要改“+10”的用户心智。
  - 广告补给变为“约 1 次生成”，更符合常见激励节奏。
- 风险：
  - 需要一次性调整所有模板成本与前端“余额不足”提示的体验预期。

**方向 B：保持模板 cost=1~3，不动成本，把广告/每日奖励下调到 1~3（更轻量但要改 UI）**
- 例：广告 +2、每日 +1。
- 好处：改动小、经济收敛。
- 风险：需要改所有文案（目前 UI 多处写死了 `+10`），且用户获得感下降。

建议：如果你希望后续做商业化与长期留存，方向 A 的可控性更强（奖励值不变，成本规模化更统一）；如果只是 Demo/短周期验证，现状也能跑通玩法但长期会失真。

### 5.3 未定义 cost 的处理建议

当前模板同步逻辑里：若模板未写 `cost`，会默认为 `1`。

建议的更稳方案（后续可实现）：
- 模板 cost 缺失时直接标记为 `inactive`，避免无意“免费/低价”模板破坏经济系统；
- 或至少在后台模板同步时输出告警，确保运营上线前补齐。

## 6. 明细展示（中文化）建议

当前后端流水字段使用英文枚举（`type=RECHARGE/CONSUME/REROLL`，`reason=AD/DAILY/...`）是合理的：利于机器统计与长期兼容。

前端展示层建议统一做中文映射：
- `RECHARGE` -> `充值`
- `CONSUME` -> `消费`
- `DAILY` -> `每日补给`
- `AD` -> `广告补给`
- `AD_REROLL` -> `广告重抽补贴`
- `GENERATE` -> `生成情绪卡`
- `REROLL_GENERATE` -> `重抽生成`

对应实现位置：
- [ledger.js](file:///Users/zhumingjun/ai/affectlab/pages/ledger/ledger.js)

## 7. 明细页分页/隐私/汇总（已按设计实现）

### 7.1 分页加载（每页 20 条）

- 明细页不再一次性拉全量（之前 `limit=200` 且前端截断），改为：
  - 每次只拉 20 条；
  - 滚动到底部自动加载下一页（下拉展示新的 20 条）。

### 7.2 用户隔离（不能看到其它用户）

- 明细接口 `GET /affectlab/api/user/transactions` 必须带 token，后端按 `user_id` 过滤。
- 明细页前端只请求“当前 token 对应的用户流水”，无法看到其它用户数据。

### 7.3 总充值 / 总消费

- 明细页顶部展示：
  - `累计充值 = affectlab_user_balance.total_recharge`
  - `累计消费 = affectlab_user_balance.total_consume`
- 数据来源：`GET /affectlab/api/user/me`
