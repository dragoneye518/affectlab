# 赛博情绪实验室 - 前端技术方案说明书

## 1. 技术栈与环境
- **平台**：微信小程序 (Native)
- **基础库**：无依赖纯原生 (WXML, WXSS, JS, JSON)
- **样式库**：手动复刻 Tailwind CSS 核心 Utility Classes (基于 rpx 单位，2rpx = 1px)
- **AI 模型**：后端 AI 服务（默认 Qwen3 文本模型）
- **后端**：FastAPI 网关+业务服务 `affectlab_server.py`（`/affectlab/api/` 前缀，默认端口 `12017`）
- **存储**：wx.setStorageSync（本地兜底缓存：历史、钱包、token）
- **构建**：无构建工具，原生开发模式

## 2. 目录结构
```
/
├── components/          # 组件库 (均开启 styleIsolation: 'apply-shared')
│   ├── navbar/          # 顶部导航 (糖果/签到)
│   ├── bottom-nav/      # 底部导航 (Tab切换)
│   ├── template-card/   # 首页模版卡片
│   ├── custom-entry-card/ # 底部通用入口卡片
│   ├── input-overlay/   # 输入弹窗 (含AI逻辑)
│   ├── holo-card/       # 结果页 3D 卡片 (含 Tilt 动画)
│   ├── radar/           # 筛选雷达弹窗
│   ├── ad-overlay/      # 模拟广告弹窗
│   ├── daily-sign-in/   # 签到弹窗
│   ├── confetti/        # 粒子特效 (Canvas 2D)
│   └── toast/           # 轻提示
├── pages/
│   └── index/           # 单页应用主入口 (Home/Mine/Result 切换)
├── utils/
│   ├── api.js           # DeepSeek API 封装 (含 Fallback)
│   ├── constants.js     # 模版数据/图片资源配置 (Source of Truth)
│   └── util.js          # 工具函数 (Hash, Time)
├── app.js               # 全局逻辑 (生命周期)
├── app.wxss             # 全局样式 (Tailwind-like Utilities + Animations)
└── project.config.json  # 项目配置 (miniprogramRoot: "./")
```

## 3. 核心模块实现逻辑

### 3.1 样式系统 (app.wxss)
由于不使用构建工具，我们在 `app.wxss` 中手动实现了一套 Tailwind 风格的原子类库，并配置所有组件使用 `styleIsolation: 'apply-shared'` 以继承全局样式：
- **颜色变量**：`--neon-pink: #ff00ff`, `--neon-blue: #00ffff` 等。
- **布局**：`flex`, `grid`, `absolute`, `relative`, `inset-0`.
- **间距**：`p-4` (32rpx), `gap-2` (16rpx), `m-auto`.
- **视觉**：`bg-black` (#050505), `backdrop-blur` (rgba(20,20,20,0.8)).
- **动画**：
  - `animate-pulse`, `animate-spin`, `animate-shine`
  - `animate-tilt`: 3D 摇晃效果
  - `animate-glitch`: 故障偏移效果
  - `animate-zoom-in`: 弹窗进入动画
- **字体**：`font-family: 'Noto Sans SC'`, `font-black`, `italic`.

### 3.2 状态管理
采用**单页模式 (SPA-like)**，所有视图在 `pages/index/index` 中通过 `wx:if` 切换，避免页面跳转带来的白屏：
- `view`: 'HOME' | 'INPUT' | 'GENERATING' | 'RESULT' | 'MINE'
- `candyCount`: 积分余额 (本地存储 'candy_count')
- `history`: 生成记录 (本地存储 'history_list')
- `categoryFilter` / `searchTerm`: 筛选状态

### 3.3 3D 卡片交互 (HoloCard)
复刻 H5 的 `mousemove` 效果，在小程序中使用 `touchmove` 事件：
- 监听触摸点坐标 `(e.touches[0].clientX, Y)`。
- 计算相对于卡片中心的偏移量。
- 设置 CSS `transform: rotateX(...) rotateY(...)`。
- 动态调整高光层 (`background-image` gradient) 的位置。
- 结束触摸时复位 (`handleTouchEnd`)。

### 3.4 AI 接入与容错
封装 `utils/api.js`：
- **统一网关**：`requestAffectLab` 负责拼接 `affectlab_api_base` 与注入 `Authorization: Bearer <token>`。
- **文案转译**：`/affectlab/api/text/polish` 返回 JSON（TOXIC/EMO/GLITCH + recommendedTemplateId）。
- **登录/鉴权**：启动时调用 `/affectlab/api/user/login` 获取 token，写入 `wx.setStorageSync('affectlab_token')`。
- **Fallback**：后端不可用时，自动降级为本地预设结果；生成流程也保留本地兜底生成，确保不卡流程。

### 3.5 资源管理
- **图片**：使用阿里云 OSS 链接 (统一管理在 `constants.js` 的 `TEMPLATE_ASSETS` 中)。
- **预加载**：关键资源提前请求。

## 4. 差异化处理 (H5 vs WeChat)
| 功能 | H5 实现 | 微信小程序实现 |
| :--- | :--- | :--- |
| **路由** | React State | `wx:if` 条件渲染 (单页) |
| **样式** | Tailwind CSS | `app.wxss` 手写原子类 (rpx) + `apply-shared` |
| **特效** | DOM 操作 / CSS | 小程序 WXSS 动画 / Canvas 2D (Confetti) |
| **交互** | Mouse Event | Touch Event (bindtouchmove) |
| **存储** | localStorage | wx.setStorageSync |
| **配置** | vite.config.ts | project.config.json |
