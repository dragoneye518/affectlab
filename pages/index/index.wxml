<view class="min-h-screen bg-black text-white font-sans pb-20 relative">
  <!-- Background Noise -->
  <view class="fixed inset-0 pointer-events-none z-0 opacity-10 bg-stardust"></view>

  <navbar 
      candyCount="{{candyCount}}" 
      canClaimDaily="{{canClaimDaily}}"
      bind:watchAd="onWatchAd" 
      bind:openDaily="onOpenDaily"
  />

  <view class="px-4 max-w-md mx-auto relative z-10" style="padding-top: {{contentPaddingTop}}px;">
      <view class="animate-fade-in">
              <!-- Countdown Banner -->
              <view class="mx-4 mb-4 p-1 rounded-xl bg-gradient-banner active-scale-95 transition-transform hover-shadow-red relative overflow-hidden group">
                  <view class="bg-black-90 backdrop-blur rounded-lg p-4 flex items-center justify-between relative z-10">
                      <view class="z-10">
                          <view class="flex items-center gap-2 mb-1">
                              <view class="flex h-2 w-2 relative">
                                  <view class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-75"></view>
                                  <view class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></view>
                              </view>
                              <text class="text-red-400 text-xs-mini font-black tracking-widest uppercase">SEASON 1 FINALE</text>
                          </view>
                          <view class="text-white font-black italic text-lg leading-tight">
                              2026 赛博庙会
                              <view class="text-gray-400 text-xs font-normal not-italic">Cyber Temple Fair Limited Event</view>
                          </view>
                      </view>
                      <view class="z-10 text-right">
                          <text class="block text-xs-mini text-gray-500 mb-1 uppercase tracking-wider font-bold">Time Remaining</text>
                          <view class="font-mono text-xl font-bold text-white tracking-wider flex items-center gap-1 justify-end">
                              <image src="https://api.iconify.design/lucide:timer.svg?color=%23ef4444" class="w-4 h-4" />
                              <text>{{timeLeft.d}}<text class="text-xs text-gray-500 mx-0-5">d</text>{{timeLeft.h}}<text class="text-xs text-gray-500 mx-0-5">:</text>{{timeLeft.m}}</text>
                          </view>
                      </view>
                  </view>
              <view class="absolute top-0 -inset-full h-full w-1-2 z-5 block transform -skew-x-12 bg-gradient-shine opacity-20 shine-on-active"></view>
              </view>

              <!-- Filters -->
              <scroll-view scroll-x show-scrollbar="false" class="flex gap-2 mb-4 h-12 whitespace-nowrap" enable-flex style="flex-direction: row; display: flex;">
                  <view 
                      bindtap="onOpenRadar" 
                      class="flex-shrink-0 w-12 h-12 rounded-xl border flex items-center justify-center active-scale-95 transition-transform {{categoryFilter ? 'bg-neon-pink text-white border-neon-pink' : 'bg-dark-800 border-white-10 text-neon-pink'}}"
                  >
                      <image src="{{categoryFilter ? 'https://api.iconify.design/lucide:radar.svg?color=%23ffffff' : 'https://api.iconify.design/lucide:radar.svg?color=%23ff00ff'}}" class="w-5 h-5" />
                  </view>
                  
                  <block wx:if="{{categoryFilter || searchTerm}}">
                      <view bindtap="clearFilter" class="flex-shrink-0 px-4 h-12 rounded-xl bg-white-10 flex items-center gap-2 text-sm font-bold border border-white-20">
                          <image src="https://api.iconify.design/lucide:x.svg?color=white" class="w-3 h-3" />
                          <text>{{categoryFilter ? categoryFilter : searchTerm}}</text>
                      </view>
                  </block>

                  <block wx:for="{{['HOT','NEW','LIMITED']}}" wx:key="*this">
                      <view 
                          bindtap="onTagFilter"
                          data-tag="{{item}}"
                          class="flex-shrink-0 px-4 h-12 rounded-xl border text-xs font-bold transition-colors flex items-center {{searchTerm === item ? 'bg-white text-black border-white' : 'bg-dark-800 border-white-10 text-gray-400'}}"
                      >
                          {{item}}
                      </view>
                  </block>
              </scroll-view>

              <!-- Template Grid -->
              <view class="grid grid-cols-2 gap-4">
                  <block wx:for="{{filteredTemplates}}" wx:key="id">
                    <template-card template="{{item}}" bind:select="onTemplateSelect" />
                </block>
                
                <block wx:if="{{!categoryFilter && !searchTerm}}">
                  <custom-entry-card bind:select="onCustomSignalSelect" class="col-span-2 mt-6 mb-7 mx-4" />
                </block>
            </view>
              
              <block wx:if="{{templatesLoading}}">
                  <view class="text-center py-20 opacity-50 text-sm">正在加载模板...</view>
              </block>

              <block wx:if="{{!templatesLoading && templatesLoadError}}">
                  <view class="text-center py-20 opacity-50 text-sm">{{templatesLoadError}}</view>
              </block>

              <block wx:if="{{filteredTemplates.length === 0}}">
                  <view class="text-center py-20 opacity-50 text-sm">No signals detected.</view>
              </block>
      </view>
  </view>

  <!-- OVERLAYS -->
  
  <!-- Sign In Modal -->
  <block wx:if="{{showSignIn}}">
      <view class="fixed inset-0 z-70 bg-black-95 backdrop-blur flex flex-col items-center justify-center animate-zoom-in animate-fade-in" catchtouchmove="preventTouchMove">
          <view class="w-full max-w-sm p-6 text-center relative">
              <view class="absolute top-0 left-1-2 -translate-x-1-2 -translate-y-1-2">
                  <view class="w-24 h-24 bg-neon-yellow-20 rounded-full blur-xl {{canClaimDaily ? 'animate-pulse' : ''}}"></view>
                  <image src="https://api.iconify.design/lucide:gift.svg?color=%23ffff00" class="w-16 h-16 relative z-10 {{canClaimDaily ? 'animate-bounce' : 'grayscale opacity-50'}}" />
              </view>
              
              <view class="text-3xl font-black italic text-white mt-12 mb-2">每日补给</view>
              <view class="text-gray-400 text-sm mb-8">Daily Energy Supply</view>
              
              <view class="bg-dark-800 border {{canClaimDaily ? 'border-neon-yellow-50' : 'border-white-10'}} rounded-xl p-6 mb-8 transform rotate-1">
                  <view class="text-4xl font-black flex items-center justify-center gap-2 {{canClaimDaily ? 'text-neon-yellow' : 'text-gray-500'}}">
                      +10 <image src="https://api.iconify.design/lucide:candy.svg?color=currentColor" class="w-8 h-8" />
                  </view>
                  <view class="text-xs text-gray-500 mt-2 font-mono">NEXT REFRESH: 24:00:00</view>
              </view>

              <button 
                  bindtap="onClaimDaily"
                  disabled="{{!canClaimDaily}}"
                  class="btn-neon-glow w-full font-bold py-4 rounded-xl text-lg transition-transform {{canClaimDaily ? 'bg-white text-black hover-scale-105 hover-bg-neon-yellow' : 'bg-dark-700 text-gray-500 cursor-not-allowed border border-white-5'}}"
              >
                  {{canClaimDaily ? '收入囊中 (CLAIM)' : '今日已领取 (CLAIMED)'}}
              </button>
              
              <block wx:if="{{!canClaimDaily}}">
                  <view bindtap="closeSignIn" class="mt-4 text-sm text-gray-400 underline">关闭</view>
              </block>
          </view>
      </view>
  </block>

  <!-- Ad Overlay -->
  <block wx:if="{{showAd}}">
      <view class="fixed inset-0 z-100 bg-black flex flex-col items-center justify-center animate-zoom-in animate-fade-in" catchtouchmove="preventTouchMove">
           <view class="absolute inset-0 bg-gradient-ad flex flex-col items-center justify-center">
              <view class="w-64 h-64 bg-white-10 rounded-xl flex items-center justify-center mb-8 animate-pulse relative overflow-hidden">
                  <text class="text-white-50 font-black text-2xl relative z-10">ADVERTISEMENT</text>
                  <view class="absolute inset-0 bg-gradient-shine animate-shine"></view>
              </view>
              <view class="text-2xl font-bold text-white mb-2">
                  {{adType === 'REROLL' ? '正在连接高维宇宙...' : '能量补充中...'}}
              </view>
              <view class="text-gray-400 text-sm">观看完整视频获取奖励</view>
           </view>

           <view class="absolute top-4 right-4 bg-black-50 backdrop-blur px-4 py-2 rounded-full border border-white-20">
               <block wx:if="{{adTimeLeft > 0}}">
                   <text class="text-white font-mono font-bold text-sm">广告 {{adTimeLeft}}s</text>
               </block>
               <block wx:else>
                   <view 
                      bindtap="onAdComplete"
                      class="text-neon-green font-bold text-sm flex items-center gap-1 animate-pulse"
                   >
                      <image src="https://api.iconify.design/lucide:x.svg?color=%2300ff00" class="w-3 h-3" /> 关闭领取
                   </view>
               </block>
           </view>
      </view>
  </block>

  <!-- Radar Overlay -->
  <block wx:if="{{showCategory}}">
      <view class="fixed inset-0 z-70 bg-black-95 backdrop-blur flex flex-col animate-fade-in touch-none" style="padding-top: {{statusBarHeight}}px;" catchtouchmove="preventTouchMove">
          <view class="absolute inset-0 bg-grid pointer-events-none"></view>

          <!-- Custom Header -->
          <view class="flex items-center px-6 relative z-10 flex-shrink-0" style="height: {{navBarHeight}}px;">
              <view class="flex items-center gap-2">
                  <image src="https://api.iconify.design/lucide:radar.svg?color=%23ff00ff" class="w-5 h-5 animate-spin-slow" />
                  <text class="font-bold text-lg tracking-widest text-white">RADAR_V2.0</text>
              </view>
          </view>

          <!-- Content Container -->
          <view class="flex-1 flex flex-col px-6 pb-6 w-full">
              <view class="relative mb-8 z-10 mt-4">
                  <input 
                      type="text" 
                      placeholder="探测关键词..." 
                      class="w-full bg-dark-800 border border-white-20 rounded-xl py-4 pr-4 text-white font-mono h-12"
                      style="padding-left: 3.5rem;"
                      value="{{searchTerm}}"
                      bindinput="onSearchInput"
                      bindconfirm="onSearchConfirm"
                  />
                  <image src="https://api.iconify.design/lucide:search.svg?color=gray" class="absolute left-4 top-1-2 -translate-y-1-2 w-5 h-5" />
              </view>

              <view class="mb-8 z-10">
                  <view class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                      <image src="https://api.iconify.design/lucide:zap.svg?color=gray" class="w-3 h-3" /> 信号频道 (CHANNELS)
                  </view>
                  <view class="grid grid-cols-2 gap-3">
                      <block wx:for="{{categories}}" wx:key="id">
                          <view 
                              bindtap="onSelectCategory"
                              data-id="{{item.id}}"
                              class="relative py-4 px-3 rounded-xl border transition-all duration-300 active-scale-95 group overflow-hidden {{categoryFilter === item.id ? item.activeClass : 'border-white-10 bg-dark-800 text-gray-400'}}"
                          >
                              <view class="flex flex-col items-start relative z-10">
                                  <text class="font-black text-sm mb-1 {{categoryFilter === item.id ? 'text-white' : ''}}">{{item.label}}</text>
                                  <text class="text-xs-mini font-mono opacity-70">{{item.sub}}</text>
                              </view>
                              <block wx:if="{{categoryFilter === item.id}}">
                                  <view class="absolute top-2 right-2 w-2 h-2 rounded-full bg-white animate-pulse"></view>
                              </block>
                          </view>
                      </block>
                  </view>
              </view>

              <view class="z-10 flex-1">
                  <view class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                      <image src="https://api.iconify.design/lucide:flame.svg?color=gray" class="w-3 h-3" /> 热门频段 (TRENDING)
                  </view>
                  <view class="flex flex-wrap gap-2">
                      <block wx:for="{{['#搞钱', '#发疯', '#水逆', '#恋爱', '#离职', '#社恐', '#蛇年']}}" wx:key="*this">
                          <view 
                              bindtap="onTagSearch"
                              data-tag="{{item}}"
                              class="border px-4 py-2 rounded-full text-xs font-medium transition-colors active-scale-95 {{searchTerm === item ? 'bg-neon-blue-20 border-neon-blue text-neon-blue' : 'bg-dark-800 border-white-10 text-gray-300'}}"
                          >
                              {{item}}
                          </view>
                      </block>
                  </view>
              </view>

              <view class="w-full mt-auto flex gap-3 z-10">
                  <view 
                      bindtap="onRadarConfirm"
                      class="flex-1 py-4 rounded-xl bg-neon-blue text-black text-sm font-bold active-scale-95 transition-all flex items-center justify-center shadow-neon-blue hover-brightness-110"
                  >
                      确定
                  </view>

                  <view 
                      bindtap="onRadarCancel"
                      class="flex-1 py-4 rounded-xl border border-white-10 text-gray-400 text-sm font-bold active-scale-95 transition-all flex items-center justify-center bg-dark-800"
                  >
                      取消
                  </view>
                  
                  <view 
                      bindtap="resetRadar"
                      class="px-5 rounded-xl border border-white-10 bg-white-5 flex items-center justify-center active-scale-95 transition-all"
                  >
                      <image src="https://api.iconify.design/lucide:rotate-ccw.svg?color=gray" class="w-5 h-5" />
                  </view>
              </view>
          </view>
      </view>
  </block>

  <!-- Input Overlay -->
  <block wx:if="{{isInputting && selectedTemplate}}">
      <input-overlay 
          template="{{selectedTemplate}}" 
          initialValue="" 
          bind:cancel="closeInput" 
          bind:confirm="onInputConfirm" 
          bind:switchTemplate="onSwitchTemplate" 
      />
  </block>

  <!-- Generating View -->
  <block wx:if="{{view === 'GENERATING' && selectedTemplate}}">
      <generating-view 
          template="{{selectedTemplate}}" 
          userInput="{{userInput}}" 
          freeGenerateOnce="{{freeGenerateOnce}}"
          bind:finish="onGenerationFinish"
          bind:insufficient="onGenerateInsufficient"
          bind:error="onGenerationError"
      />
  </block>

  <!-- Result View -->
  <block wx:if="{{view === 'RESULT' && generatedResult}}">
      <result-view 
          result="{{generatedResult}}" 
          bind:close="closeResult" 
          bind:reroll="startReroll" 
          bind:share="onShowShareOverlay"
      />
  </block>

  <!-- Shared Result View -->
  <block wx:if="{{sharedResult}}">
      <result-view 
          result="{{sharedResult}}" 
          isSharedView="{{true}}"
          bind:close="closeSharedResult" 
          bind:reroll="closeSharedResult"
      />
  </block>

  <!-- Share Overlay -->
  <block wx:if="{{showShare}}">
      <share-overlay bind:close="closeShareOverlay" />
  </block>

</view>
