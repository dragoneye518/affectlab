# 赛博情绪实验室 - 后端技术方案详细设计说明书

## 1. 目标与范围
- 目标：为微信小程序提供统一后端网关与业务服务，承接登录鉴权、模板检索、AI 文案转译、情绪卡生成记录、背包与明细能力，并以 MySQL 为唯一数据源。
- 范围：微信版本（胶囊/背包/我的/明细）所需的核心接口与数据表；图片与模板资源默认使用 OSS 公开链接；AI 文案默认使用 ModelScope（Qwen3）文本模型。

## 2. 服务拆分与端口
### 2.1 服务列表
- `server_py/affectlab_server.py`：网关+业务服务（端口 `12017`，URL 前缀 `/affectlab/api/`）
- `server_py/affectlab_user_service.py`：用户与积分子服务（作为 router 被网关挂载，同时也提供 DB 连接与积分扣减方法）

### 2.2 路由组织
- 网关：`FastAPI` 应用 `app`，统一挂载 `user_router`
- 业务：模板、生成、背包列表等业务路由均在 `affectlab_server.py` 中实现

## 3. 鉴权设计
### 3.1 Token
- 使用 `JWT (HS256)`。
- token 存储于小程序本地：`wx.setStorageSync('affectlab_token')`。
- 需要登录的接口：除 `POST /user/login` 与 `POST /text/polish` 外，均要求 `Authorization: Bearer <token>`。

### 3.2 微信登录
- `POST /affectlab/api/user/login`：
  - 线上：使用 `WECHAT_APP_ID/WECHAT_APP_SECRET` 调用 `jscode2session` 获取 `openid`
  - 本地/无配置：使用 `mock_openid_<code>` 生成稳定 openid 进行联调

## 4. 数据库设计（MySQL: `affect_lab`）
### 4.1 复用表
- `user_profile`：用户基础信息
- `user_transactions`：充值/消费/广告/重抽等流水

### 4.2 新增表
- `affectlab_third_party_accounts`
  - 目的：openid ↔ user_id 映射（避免污染既有 third_party 表结构）
- `affectlab_user_balance`
  - 目的：余额聚合与日签幂等（`last_daily_date`）
- `affectlab_emotion_template`
  - 目的：将前端 `utils/constants.js` 模板数据落库，支持搜索/分类/排序与后续运营化
- `affectlab_emotion_card_record`
  - 目的：情绪卡生成记录（背包数据源），记录 `rarity/luck_score/image_url/cost_points`

### 4.3 初始化策略
- 服务启动后首次访问模板相关接口时，会检测 `affectlab_emotion_template` 是否为空：
  - 为空：从 `utils/constants.js` 解析 `TEMPLATES` 与 `TEMPLATE_ASSETS` 并写入表中
  - 非空：不重复写入

## 5. 接口设计
### 5.1 用户与积分
- `POST /affectlab/api/user/login`
  - 入参：`{ code: string, userInfo?: object }`
  - 出参：`{ code:200, data:{ token,user_id,openid,balance } }`
- `GET /affectlab/api/user/me`
  - 出参：用户信息 + 余额聚合
- `GET /affectlab/api/user/balance`
  - 出参：`{ balance }`
- `GET /affectlab/api/user/transactions?limit=&offset=`
  - 出参：流水列表（用于“明细/统计”）
- `POST /affectlab/api/user/reward/daily`
  - 逻辑：按 `last_daily_date` 幂等，每天仅可领取一次（默认 +10）
- `POST /affectlab/api/user/reward/ad`
  - 逻辑：广告奖励（默认 +10）

### 5.2 模板与搜索
- `GET /affectlab/api/templates?kw=&category=&tag=&limit=&offset=`
  - 逻辑：从 `affectlab_emotion_template` 查询，支持标题/描述模糊匹配

### 5.3 文案转译
- `POST /affectlab/api/text/polish`
  - 入参：`{ inputText: string }`
  - 出参（成功）：`{ options:[{style,text}...], recommendedTemplateId }`
  - 降级：后端 AI 不可用时返回本地兜底三条短句

### 5.4 情绪卡生成与背包
- `POST /affectlab/api/cards/generate`
  - 入参：`{ templateId: string, userInput: string, free?: boolean }`
  - 逻辑：
    - `free=true`：不扣积分，记一条 `REROLL` 类型流水（reason=AD）
    - 否则：扣减模板 `cost`，流水 type=CONSUME，reason=GENERATE
    - 生成：按概率生成 `N/R/SR/SSR` + `luckScore`，并根据模板 `assets` 选择图片 URL
    - 写入：`affectlab_emotion_card_record`
  - 出参：`{ code:200, data:{ result } }`，result 结构与前端 `generatedResult` 对齐
- `GET /affectlab/api/cards?limit=&offset=`
  - 逻辑：读取 `affectlab_emotion_card_record`，用于背包列表

## 6. 与前端的关键对齐点
- 余额：前端展示以 `/user/balance` 为准（本地钱包仅作兜底与即时反馈）
- 生成：前端生成中组件优先请求 `/cards/generate`，失败则本地兜底生成，避免流程中断
- 重抽：前端“看广告再来一次”完成后写入 `cp_free_generate_once=true`，下一次生成携带 `free=true`

## 7. 环境变量（不写入任何密钥）
- 数据库：`MYSQL_HOST` `MYSQL_PORT` `MYSQL_USER` `MYSQL_PASSWORD` `MYSQL_DATABASE`（默认 `affect_lab`）
- 鉴权：`SECRET_KEY`
- 微信：`WECHAT_APP_ID` `WECHAT_APP_SECRET`
- AI：`MODELSCOPE_API_KEYS`（逗号分隔多个 key），可选 `AFFECTLAB_TEXT_MODEL`
- 服务：`PORT`（默认 `12017`）

## 8. 验证清单
- 登录：小程序启动后可获取 token，`/user/me` 返回 200
- 余额：`/user/balance` 与前端显示一致
- 日签：同一天重复领取返回 400（幂等）
- 广告：完成广告后余额增加，且流水新增一条 RECHARGE(reason=AD)
- 生成：生成后余额扣减，背包列表新增记录；SSR/SR 等稀有度展示正常
- 重抽：观看广告后下一次生成不扣积分，且流水新增 REROLL(reason=AD)

