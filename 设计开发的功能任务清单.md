# 设计开发的功能任务清单

## 1. 胶囊（模板列表/雷达搜索）
- 任务：模板列表从后端读取
  - 业务逻辑：支持分类/标签/关键词搜索；按 `sort_order` 排序
  - 数据存储：读 `affectlab_emotion_template`
  - 验证：`GET /affectlab/api/templates` 返回数量与前端常量一致（首次自动灌库）
- 任务：保留本地模板兜底
  - 业务逻辑：后端不可用时仍能正常展示模板列表
  - 数据存储：无
  - 验证：断网/服务停机时小程序可进入首页并可选模板

## 2. 情绪注入（输入弹窗/AI 信号转译）
- 任务：文案转译改为后端接口
  - 业务逻辑：提交用户输入，返回 TOXIC/EMO/GLITCH 三种文案与推荐模板
  - 数据存储：无
  - 验证：`POST /affectlab/api/text/polish` 能返回合法 JSON；异常时前端展示 fallback

## 3. 生成中/生成结果（扣除算力、记录生成）
- 任务：生成改为后端生成
  - 业务逻辑：校验 token；按模板 cost 扣积分；生成 rarity/luckScore/文案；写入生成记录
  - 数据存储：写 `user_transactions`、写 `affectlab_emotion_card_record`、读 `affectlab_emotion_template`
  - 验证：生成一次后余额减少；背包列表新增记录；稀有度与图片 URL 正常
- 任务：离线兜底生成
  - 业务逻辑：后端生成失败时，使用本地随机逻辑与资源生成结果
  - 数据存储：写本地 `cp_history`（兜底）
  - 验证：断网情况下依然可完成生成并进入结果页

## 4. 看广告（补给/重抽）
- 任务：广告补给入账
  - 业务逻辑：广告完成后调用后端奖励接口，余额 +10
  - 数据存储：写 `user_transactions`、写 `affectlab_user_balance`
  - 验证：`POST /affectlab/api/user/reward/ad` 返回的新余额与前端一致
- 任务：广告重抽不扣积分
  - 业务逻辑：广告完成后设置一次性 flag；下一次生成携带 `free=true`，后端不扣积分但记录一条重抽流水
  - 数据存储：写 `user_transactions`（type=REROLL）
  - 验证：重抽生成时余额不变，明细新增一条 REROLL

## 5. 背包（历史记录）
- 任务：背包数据改为后端拉取
  - 业务逻辑：按时间倒序分页；点击可回到结果页复看
  - 数据存储：读 `affectlab_emotion_card_record`
  - 验证：`GET /affectlab/api/cards` 返回与生成记录一致；无 token 时回退本地 `cp_history`

## 6. 我的（余额/统计/明细）
- 任务：我的页余额来自后端
  - 业务逻辑：展示用户信息、余额与统计
  - 数据存储：读 `user_profile`、读 `affectlab_user_balance`
  - 验证：`GET /affectlab/api/user/me` 返回数据完整
- 任务：明细来自后端流水
  - 业务逻辑：区分充值/消费；用于统计 AD/DAILY/CONSUME 次数
  - 数据存储：读 `user_transactions`
  - 验证：`GET /affectlab/api/user/transactions` 返回顺序正确、分页可用

## 7. 安全与稳定性
- 任务：不在前端/仓库中硬编码密钥
  - 业务逻辑：所有密钥通过服务端环境变量注入
  - 数据存储：无
  - 验证：代码中不存在明文 key；运行依赖 `.env` 或环境变量
- 任务：异常兜底与降级
  - 业务逻辑：后端不可用时，前端不阻塞流程；后端 AI 不可用时返回 fallback
  - 数据存储：无
  - 验证：停掉后端/断网时主链路仍可走通（至少本地兜底）

